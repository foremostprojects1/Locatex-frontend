<!DOCTYPE html>
<html lang="zxx">
<head>
    <title>Housy - Real Estate HTML5 Template</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="utf-8">

    <!-- External CSS libraries -->
    <link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="css/animate.min.css">
    <link rel="stylesheet" type="text/css" href="css/bootstrap-submenu.css">
    <link rel="stylesheet" type="text/css" href="css/bootstrap-select.min.css">
    <link rel="stylesheet" href="css/leaflet.css" type="text/css">
    <link rel="stylesheet" href="css/map.css" type="text/css">
    <link rel="stylesheet" type="text/css" href="fonts/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="fonts/flaticon/font/flaticon.css">
    <link rel="stylesheet" type="text/css" href="fonts/linearicons/style.css">
    <link rel="stylesheet" type="text/css"  href="css/jquery.mCustomScrollbar.css">
    <link rel="stylesheet" type="text/css"  href="css/dropzone.css">
    <link rel="stylesheet" type="text/css"  href="css/slick.css">

    <!-- Custom stylesheet -->
    <link rel="stylesheet" type="text/css" href="css/style.css">
    <link rel="stylesheet" type="text/css" id="style_sheet" href="css/skins/default.css">

    <!-- Favicon icon -->
    <link rel="shortcut icon" href="img/favicon.ico" type="image/x-icon" >

    <!-- Google fonts -->
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700%7CRoboto:300,400,500,700&display=swap">

    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <link rel="stylesheet" type="text/css" href="css/ie10-viewport-bug-workaround.css">

    <!-- Just for debugging purposes. Don't actually copy these 2 lines! -->
    <!--[if lt IE 9]><script src="js/ie8-responsive-file-warning.js"></script><![endif]-->
    <script src="js/ie-emulation-modes-warning.js"></script>

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="js/html5shiv.min.js"></script>
    <script src="js/respond.min.js"></script>
    <![endif]-->
    <style>
        /* Center the Actions column content */
#favorited-properties-table th.actions-column,
#favorited-properties-table td.actions {
    text-align: center;
    vertical-align: middle;
}

/* Make the buttons display inline and centered */
#favorited-properties-table td.actions .btn {
    display: inline-block;
    margin: 0 2px;
}

/* Style for the unfavorite button */
#favorited-properties-table td.actions .btn-outline-danger {
    border-color: #dc3545;
    color: #dc3545;
    background-color: transparent;
    transition: all 0.3s ease;
    font-size: 20px; /* Slightly bigger icon */
    padding: 6px 10px; /* Comfortable click area */
}

#favorited-properties-table td.actions .btn-outline-danger:hover {
    background-color: #dc3545;
    color: #fff;
    border-color: #dc3545;
    transform: scale(0.95); /* Slightly smaller on hover */
}

#favorited-properties-table td.actions .btn-outline-danger i {
    transition: all 0.3s ease;
}

    </style>
</head>
<body>
<div class="page_loader"></div>

<!-- Header Include -->
<div id="header-container"></div>

<script>
    // Load header.html content
    fetch('header.html')
        .then(response => response.text())
        .then(data => {
            document.getElementById('header-container').innerHTML = data;
        })
        .catch(error => {
            console.error('Error loading header:', error);
        });
</script>

<!-- Sub banner start -->
<div class="sub-banner">
    <div class="container">
        <div class="page-name">
            <h1>Favorited Properties</h1>
            <ul>
                <li><a href="index.html">Index</a></li>
                <li><span>/</span>Favorited Properties</li>
            </ul>
        </div>
    </div>
</div>

<!-- Favorited properties start -->
<div class="favorited-properties content-area">
    <div class="container">
        <div class="row">
            <div class="col-lg-4 col-md-12 col-sm-12">
                <div class="clearfix">
                    <!-- Avatar start -->
                    <div class="edit-profile-photo">
                        <img id="avatarImg" src="img/avatar/avatar-11.png" alt="profile-photo" class="img-fluid">
                        <div class="change-photo-btn">
                            <div class="photoUpload">
                                <span><i class="fa fa-upload"></i> Upload Photo</span>
                                <input type="file" id="avatarInput" class="upload" accept="image/*">
                            </div>
                        </div>
                    </div>
                    <!-- Avatar end -->
                    <!-- My account box start -->
                    <div class="my-account-box">
                        <ul>
                            <li>
                                <a href="my-profile.html" >
                                    <i class="flaticon-people"></i>My Profile
                                </a>
                            </li>
                            <li>
                                <a href="favorited-properties.html" class="active">
                                    <i class="flaticon-favorite"></i>Favorited Properties
                                </a>
                            </li>
                            <li>
                                <a href="my-properties.html">
                                    <i class="flaticon-internet"></i>My Properties
                                </a>
                            </li>
                            <li>
                                <a href="submit-property.html">
                                    <i class="flaticon-cross"></i>Submit New Property
                                </a>
                            </li>
                            <li>
                                <a href="change-password.html">
                                    <i class="flaticon-lock"></i>Change Password
                                </a>
                            </li>
                            <li>
                                <a href="#" onclick="logout()">
                                    <i class="flaticon-exit"></i>Log Out
                                </a>
                            </li>
                        </ul>
                    </div>
                    <!-- My account box end -->
                </div>
            </div>
            <div class="col-lg-8 col-md-12 col-sm-12">
                <!-- Heading -->
                <h3 class="heading-2">Favorited Properties</h3>
                <div class="my-properties">
                    <div id="favorited-properties-container">
                        <div class="text-center" id="loading-message">
                            <p>Loading your favorited properties...</p>
                        </div>
                        <div class="text-center" id="empty-message" style="display: none;">
                            <p>You haven't favorited any properties yet.</p>
                            <p><a href="properties-list-rightside.html" class="btn button-theme">Browse Properties</a></p>
                        </div>
                        <table class="table brd-none" id="favorited-properties-table" style="display: none;">
                            <thead>
                            <tr>
                                <th>Property</th>
                                <th></th>
                                <th class="hedin-div">Date Added</th>
                                <th class="actions-column"><span class="hedin-div" style="color: #333;">Actions</span></th>
                            </tr>
                            </thead>
                            <tbody id="favorited-properties-body">
                            <!-- Dynamic content will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Footer start -->
<div id="footer-container"></div>

<script>
    // Load footer.html content
    fetch('footer.html')
        .then(response => response.text())
        .then(data => {
            document.getElementById('footer-container').innerHTML = data;
        })
        .catch(error => {
            console.error('Error loading footer:', error);
        });
</script>

<script src="js/jquery-2.2.0.min.js"></script>
<script src="js/popper.min.js"></script>
<script src="js/bootstrap.min.js"></script>
<script src="js/bootstrap-submenu.js"></script>
<script src="js/rangeslider.js"></script>
<script src="js/jquery.mb.YTPlayer.js"></script>
<script src="js/wow.min.js"></script>
<script src="js/bootstrap-select.min.js"></script>
<script src="js/jquery.easing.1.3.js"></script>
<script src="js/jquery.scrollUp.js"></script>
<script src="js/jquery.mCustomScrollbar.concat.min.js"></script>
<script src="js/leaflet.js"></script>
<script src="js/leaflet-providers.js"></script>
<script src="js/leaflet.markercluster.js"></script>
<script src="js/dropzone.js"></script>
<script src="js/slick.min.js"></script>
<script src="js/jquery.filterizr.js"></script>
<script src="js/jquery.magnific-popup.min.js"></script>
<script src="js/jquery.countdown.js"></script>
<script src="js/maps.js"></script>
<script src="js/app.js"></script>
<script>
    // Make functions globally available
    window.removeFromFavorites = removeFromFavorites;
    window.formatPrice = formatPrice;

    function removeFromFavorites(propertyId) {
        var favoritedProperties = JSON.parse(localStorage.getItem('favoritedProperties') || '[]');
        favoritedProperties = favoritedProperties.filter(function(property) {
            return property._id !== propertyId;
        });
        localStorage.setItem('favoritedProperties', JSON.stringify(favoritedProperties));
        loadFavoritedProperties(); // Reload the list
    }

    function formatPrice(price) {
        if (!price) return 'N/A';
        try {
            return '‚Çπ ' + Number(price).toLocaleString();
        } catch (e) {
            return '‚Çπ ' + price;
        }
    }

    function setAvatarFromUser(user) {
        var avatarImgEl = document.getElementById('avatarImg');
        if (!avatarImgEl) return;
        if (user && user.avatar) {
            avatarImgEl.src = user.avatar;
        } else {
            avatarImgEl.src = 'img/avatar/avatar-11.png';
        }
    }

    function getCurrentUser() {
        try { return JSON.parse(localStorage.getItem('current_user') || 'null'); } catch (e) { return null; }
    }

    function loadFavoritedProperties() {
        console.log('üîÑ Loading favorited properties...');
        var favoritedProperties = JSON.parse(localStorage.getItem('favoritedProperties') || '[]');
        console.log('üìã Found favorited properties:', favoritedProperties.length);

        var container = document.getElementById('favorited-properties-container');
        var loadingMessage = document.getElementById('loading-message');
        var emptyMessage = document.getElementById('empty-message');
        var table = document.getElementById('favorited-properties-table');
        var tbody = document.getElementById('favorited-properties-body');

        // Hide loading message
        if (loadingMessage) loadingMessage.style.display = 'none';

        if (favoritedProperties.length === 0) {
            console.log('‚ùå No favorited properties found');
            if (emptyMessage) emptyMessage.style.display = 'block';
            if (table) table.style.display = 'none';
            return;
        }

        console.log('‚úÖ Found favorited properties:', favoritedProperties);
        if (emptyMessage) emptyMessage.style.display = 'none';
        if (table) table.style.display = 'table';

        var html = '';
        favoritedProperties.forEach(function(property) {
            console.log('üè† Processing property:', property.title, 'ID:', property._id);
            var img = (property.images && property.images[0] && property.images[0].url) || 'img/dummy-property.png';
            var city = (property.location && property.location.city) || '';
            var state = (property.location && property.location.state) || '';
            var locationText = city && state ? city + ', ' + state.charAt(0).toUpperCase() + state.slice(1) :
                              city || state || 'Location not available';

            html += '<tr>' +
                '<td class="image">' +
                    '<a href="properties-details.html?id=' + property._id + '">' +
                        '<img alt="property" src="' + img + '" class="img-fluid" style="width: 80px; height: 60px; object-fit: cover;">' +
                    '</a>' +
                '</td>' +
                '<td>' +
                    '<div class="inner">' +
                        '<h5><a href="properties-details.html?id=' + property._id + '">' + (property.title || 'Untitled Property') + '</a></h5>' +
                        '<figure class="hedin-div"><i class="fa fa-map-marker"></i> ' + locationText + '</figure>' +
                        '<div class="price-month">' + formatPrice(property.price) + '</div>' +
                    '</div>' +
                '</td>' +
                '<td class="hedin-div">' + (property.dateAdded ? new Date(property.dateAdded).toLocaleDateString() : 'N/A') + '</td>' +
                '<td class="actions">' +
                    '<a href="properties-details.html?id=' + property._id + '" class="btn btn-sm btn-info"><i class="fa fa-eye"></i> View</a>' +
                    '<button onclick="removeFromFavorites(\'' + property._id + '\')" class="btn btn-sm btn-outline-danger" title="Remove from favorites">' +
                        '<i class="fa fa-heart"></i>' +
                    '</button>' +
                '</td>' +
            '</tr>';
        });

        console.log('üìù Generated HTML length:', html.length);
        if (tbody) tbody.innerHTML = html;
    }

    // Load user avatar and favorited properties when page loads
    document.addEventListener('DOMContentLoaded', function() {
        // Load user avatar
        var currentUser = getCurrentUser();
        if (currentUser) {
            setAvatarFromUser(currentUser);
        }

        // Load favorited properties
        loadFavoritedProperties();
    });

    // Global logout function (accessible from HTML onclick) - Now uses modal
    function logout() {
        $('#logoutModal').modal('show');
    }

    // Handle logout confirmation from modal - Using event delegation
    document.addEventListener('click', function(e) {
        if (e.target && e.target.id === 'confirmLogoutBtn') {
            localStorage.removeItem('auth_token');
            localStorage.removeItem('token');
            localStorage.removeItem('current_user');

            // Close modal and redirect
            $('#logoutModal').modal('hide');
            window.location.href = 'index.html';
        }
    });
</script>

<!-- Logout Confirmation Modal -->
<div id="logoutModal" class="modal fade" role="dialog">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Confirm Logout</h4>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to logout from your account?</p>
                <p class="text-muted">You will need to login again to access your account.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmLogoutBtn">Logout</button>
            </div>
        </div>
    </div>
</div>
</body>
</html>
