<!DOCTYPE html>
<html lang="zxx">
<head>
    <title>Locatex | Buy & Sell Real Estate</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="utf-8">

    <!-- External CSS libraries -->
    <link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="css/animate.min.css">
    <link rel="stylesheet" type="text/css" href="css/bootstrap-submenu.css">
    <link rel="stylesheet" type="text/css" href="css/bootstrap-select.min.css">
    <link rel="stylesheet" href="css/leaflet.css" type="text/css">
    <link rel="stylesheet" href="css/map.css" type="text/css">
    <link rel="stylesheet" type="text/css" href="fonts/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="fonts/flaticon/font/flaticon.css">
    <link rel="stylesheet" type="text/css" href="fonts/linearicons/style.css">
    <link rel="stylesheet" type="text/css"  href="css/jquery.mCustomScrollbar.css">
    <link rel="stylesheet" type="text/css"  href="css/dropzone.css">
    <link rel="stylesheet" type="text/css"  href="css/slick.css">

    <!-- Custom stylesheet -->
    <link rel="stylesheet" type="text/css" href="css/style.css">
    <link rel="stylesheet" type="text/css" id="style_sheet" href="css/skins/default.css">

    <!-- Favicon icon -->
    <link rel="shortcut icon" href="img/favicon.ico" type="image/x-icon" >

    <!-- Google fonts -->
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700%7CRoboto:300,400,500,700&display=swap">

    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <link rel="stylesheet" type="text/css" href="css/ie10-viewport-bug-workaround.css">

    <style>
        .hedin-div {
            color: #333 !important;
            font-size: 14px;
        }
        table .hedin-div {
            color: #333 !important;
        }
        .my-properties table th {
            color: #333 !important;
            background-color: #f8f9fa;
        }
        .my-properties table td {
            color: #333 !important;
        }
        .actions .delete {
            color: #dc3545 !important;
            background-color: transparent;
            border: 1px solid #dc3545;
            padding: 5px 10px;
            border-radius: 3px;
            text-decoration: none;
            margin-right: 5px;
            transition: all 0.3s ease;
        }
        .actions .delete:hover {
            background-color: #dc3545;
            color: #fff !important;
        }
        .actions .delete i {
            margin-right: 5px;
        }
        .actions .edit {
            color: #28a745 !important;
            background-color: transparent;
            border: 1px solid #28a745;
            padding: 5px 10px;
            border-radius: 3px;
            text-decoration: none;
            margin-right: 5px;
            transition: all 0.3s ease;
        }
        .actions .edit:hover {
            background-color: #28a745;
            color: #fff !important;
        }
        .actions .edit i {
            margin-right: 5px;
        }
        .my-properties table th {
            text-align: center;
            vertical-align: middle;
        }
        .my-properties table th.hedin-div {
            text-align: center;
            vertical-align: middle;
        }
        .my-properties table th span.hedin-div {
            text-align: center;
            vertical-align: middle;
        }

        /* Left align specific columns */
        .my-properties table th:nth-child(2),
        .my-properties table th:nth-child(3),
        .my-properties table th:nth-child(4) {
            text-align: left !important;
        }

        .my-properties table td:nth-child(2),
        .my-properties table td:nth-child(3),
        .my-properties table td:nth-child(4) {
            text-align: left !important;
        }

        /* Fine-tune column positioning */
        .my-properties table th:nth-child(2),
        .my-properties table td:nth-child(2) {
            padding-left: 30px !important;
        }

        .my-properties table th:nth-child(3),
        .my-properties table td:nth-child(3) {
            padding-left: 5px !important;
        }

        .my-properties table th:nth-child(4),
        .my-properties table td:nth-child(4) {
            padding-left: 5px !important;
        }
        
    </style>

    <!-- Just for debugging purposes. Don't actually copy these 2 lines! -->
    <!--[if lt IE 9]><script src="js/ie8-responsive-file-warning.js"></script><![endif]-->
    <script src="js/ie-emulation-modes-warning.js"></script>

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="js/html5shiv.min.js"></script>
    <script src="js/respond.min.js"></script>
    <![endif]-->
</head>
<body>
<div class="page_loader"></div>

<!-- Header Include -->
<div id="header-container"></div>

<script>
    // Load header.html content
    fetch('header.html')
        .then(response => response.text())
        .then(data => {
            document.getElementById('header-container').innerHTML = data;
        })
        .catch(error => {
            console.error('Error loading header:', error);
        });
</script>

<!-- Sub banner start -->
<div class="sub-banner">
    <div class="container">
        <div class="page-name">
            <h1>My Properties</h1>
            <ul>
                <li><a href="index.html">Index</a></li>
                <li><span>/</span>My Properties</li>
            </ul>
        </div>
    </div>
</div>

<!-- My properties start -->
<div class="my-properties content-area">
    <div class="container">
        <div class="row">
             <div class="col-lg-4 col-md-12 col-sm-12">
                 <div id="accountSidebar"></div>
            </div>
             <div class="col-lg-8 col-md-12 col-sm-12">
                
                 <div class="my-properties">
                     <table class="table brd-none" id="myPropertiesTable">
                         <thead>
                         <tr>
                             <th colspan="2">Property</th>
                             <th class="hedin-div">Date</th>
                             <th><span class="hedin-div">Views</span></th>
                             <th>Status</th>
                             <th>Actions</th>
                         </tr>
                         </thead>
                         <tbody id="myPropertiesBody"></tbody>
                     </table>
                 </div>
            </div>
        </div>
    </div>
</div>

<!-- Footer start -->
<div id="footer-container"></div>

<script>
    // Load footer.html content
    fetch('footer.html')
        .then(response => response.text())
        .then(data => {
            document.getElementById('footer-container').innerHTML = data;
        })
        .catch(error => {
            console.error('Error loading footer:', error);
        });
</script>

<script src="js/jquery-2.2.0.min.js"></script>
<script src="js/popper.min.js"></script>
<script src="js/bootstrap.min.js"></script>
<script src="js/bootstrap-submenu.js"></script>
<script src="js/rangeslider.js"></script>
<script src="js/jquery.mb.YTPlayer.js"></script>
<script src="js/wow.min.js"></script>
<script src="js/bootstrap-select.min.js"></script>
<script src="js/jquery.easing.1.3.js"></script>
<script src="js/jquery.scrollUp.js"></script>
<script src="js/jquery.mCustomScrollbar.concat.min.js"></script>
<script src="js/leaflet.js"></script>
<script src="js/leaflet-providers.js"></script>
<script src="js/leaflet.markercluster.js"></script>
<script src="js/dropzone.js"></script>
<script src="js/slick.min.js"></script>
<script src="js/jquery.filterizr.js"></script>
<script src="js/jquery.magnific-popup.min.js"></script>
<script src="js/jquery.countdown.js"></script>
<script src="js/maps.js"></script>
<script src="js/app.js"></script>
<script src="js/account-sidebar.js"></script>
<script>
// Auth check and fetch my properties
document.addEventListener('DOMContentLoaded', function() {
    const token = localStorage.getItem('auth_token') || localStorage.getItem('token');
    if (!token) {
        alert('Please login to view your properties.');
        window.location.href = 'login.html';
        return;
    }

    loadMyProperties();
});

function loadMyProperties() {
    const tbody = document.getElementById('myPropertiesBody');
    tbody.innerHTML = '<tr><td colspan="6">Loading...</td></tr>';

    fetch('http://localhost:5000/api/properties/my', {
        headers: {
            'Authorization': `Bearer ${localStorage.getItem('auth_token') || localStorage.getItem('token')}`
        }
    }).then(res => res.json())
      .then(res => {
        if (!res.success) throw new Error(res.message || 'Failed to load');
        const properties = res.data.properties || [];
        if (properties.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No properties found.</td></tr>';
            return;
        }
        tbody.innerHTML = properties.map(p => renderRow(p)).join('');
      })
      .catch(err => {
        console.error(err);
        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Error loading properties.</td></tr>';
      });
}

function renderRow(p) {
    const img = (p.images && p.images.length) ? p.images[0].url : 'img/dummy-property.png';
    const title = p.title || 'Untitled';
    const city = p.location && p.location.city ? p.location.city : '';
    const state = p.location && p.location.state ? p.location.state : '';
    const dateStr = p.createdAt ? new Date(p.createdAt).toLocaleDateString() : '';
    const price = p.price ? `â‚¹ ${Number(p.price).toLocaleString()}` : '';
    const views = p.views || 0;
    const status = (p.approvalStatus || 'pending');
    const statusBadge = status === 'approved' ? '<span class="badge badge-success">Approved</span>' : status === 'rejected' ? '<span class="badge badge-danger">Rejected</span>' : '<span class="badge badge-warning">Pending</span>';

    return `
    <tr>
        <td class="image"><a href="properties-details.html?id=${p._id}"><img alt="properties-small" src="${img}" class="img-fluid"></a></td>
        <td>
            <div class="inner">
                <h5><a href="properties-details.html?id=${p._id}">${title}</a></h5>
                <figure class="hedin-div"><i class="fa fa-map-marker"></i> ${city} ${state ? ', ' + state : ''}</figure>
                <div class="price-month">${price}</div>
            </div>
        </td>
        <td class="hedin-div">${dateStr}</td>
        <td><span class="hedin-div">${views}</span></td>
        <td>${statusBadge}</td>
        <td class="actions">
            <a href="properties-details.html?id=${p._id}" class="edit"><i class="fa fa-eye"></i>View</a>
            <a href="submit-property.html?id=${p._id}" class="edit"><i class="fa fa-edit"></i>Edit</a>
            <a href="#" class="delete" onclick="confirmDelete('${p._id}', '${title}')"><i class="fa fa-trash"></i>Delete</a>
        </td>
    </tr>`;
}

function confirmDelete(propertyId, propertyTitle) {
    document.getElementById('deletePropertyTitle').textContent = propertyTitle;
    document.getElementById('confirmDeleteBtn').onclick = function() {
        deleteProperty(propertyId);
    };
    $('#deleteModal').modal('show');
}

function deleteProperty(propertyId) {
    const token = localStorage.getItem('auth_token') || localStorage.getItem('token');
    if (!token) {
        alert('Please login to delete properties.');
        return;
    }

    fetch(`http://localhost:5000/api/properties/${propertyId}`, {
        method: 'DELETE',
        headers: {
            'Authorization': `Bearer ${token}`
        }
    })
    .then(res => res.json())
    .then(res => {
        if (res.success || res.status === 'success') {
            $('#deleteModal').modal('hide');
            alert('Property deleted successfully!');
            loadMyProperties(); // Reload the properties list
        } else {
            throw new Error(res.message || 'Failed to delete property');
        }
    })
    .catch(err => {
        console.error('Delete error:', err);
        alert('Error deleting property: ' + err.message);
    });
}

// Logout function with confirmation
function confirmLogout() {
    console.log('Logout function called'); // Debug log

    // Check if jQuery is available
    if (typeof $ === 'undefined') {
        console.error('jQuery not loaded');
        alert('jQuery not loaded. Cannot show modal.');
        return;
    }

    // Check if modal exists
    if (!$('#logoutModal').length) {
        console.error('Logout modal not found');
        alert('Logout modal not found in HTML.');
        return;
    }

    $('#logoutModal').modal('show');
    console.log('Modal show called'); // Debug log
}

// Handle logout confirmation from modal - Using event delegation
document.addEventListener('click', function(e) {
    if (e.target && e.target.id === 'confirmLogoutBtn') {
        localStorage.removeItem('auth_token');
        localStorage.removeItem('token');
        localStorage.removeItem('current_user');

        // Close modal and redirect
        $('#logoutModal').modal('hide');
        window.location.href = 'index.html';
    }
});
</script>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="modal fade" role="dialog">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Confirm Delete</h4>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete the property <strong id="deletePropertyTitle"></strong>?</p>
                <p class="text-danger">This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
            </div>
        </div>
    </div>
</div>

<!-- Logout Confirmation Modal -->
<div id="logoutModal" class="modal fade" role="dialog">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Confirm Logout</h4>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to logout from your account?</p>
                <p class="text-muted">You will need to login again to access your account.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmLogoutBtn">Logout</button>
            </div>
        </div>
    </div>
</div>


<!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
<script src="js/ie10-viewport-bug-workaround.js"></script>

</body>
</html>
