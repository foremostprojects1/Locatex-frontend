<!DOCTYPE html>
<html lang="zxx">
<head>
    <title>Housy - Real Estate HTML5 Template</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="utf-8">

    <!-- External CSS libraries -->
    <link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="css/animate.min.css">
    <link rel="stylesheet" type="text/css" href="css/bootstrap-submenu.css">
    <link rel="stylesheet" type="text/css" href="css/bootstrap-select.min.css">
    <link rel="stylesheet" href="css/leaflet.css" type="text/css">
    <link rel="stylesheet" href="css/map.css" type="text/css">
    <link rel="stylesheet" type="text/css" href="fonts/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="fonts/flaticon/font/flaticon.css">
    <link rel="stylesheet" type="text/css" href="fonts/linearicons/style.css">
    <link rel="stylesheet" type="text/css"  href="css/jquery.mCustomScrollbar.css">
    <link rel="stylesheet" type="text/css"  href="css/dropzone.css">
    <link rel="stylesheet" type="text/css"  href="css/slick.css">

    <!-- Custom stylesheet -->
    <link rel="stylesheet" type="text/css" href="css/style.css">
    <link rel="stylesheet" type="text/css" id="style_sheet" href="css/skins/default.css">

    <!-- Favicon icon -->
    <link rel="shortcut icon" href="img/favicon.ico" type="image/x-icon" >

    <!-- Google fonts -->
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700%7CRoboto:300,400,500,700&display=swap">

    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <link rel="stylesheet" type="text/css" href="css/ie10-viewport-bug-workaround.css">

    <!-- Just for debugging purposes. Don't actually copy these 2 lines! -->
    <!--[if lt IE 9]><script src="js/ie8-responsive-file-warning.js"></script><![endif]-->
    <script src="js/ie-emulation-modes-warning.js"></script>

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="js/html5shiv.min.js"></script>
    <script src="js/respond.min.js"></script>
    <![endif]-->
</head>
<body>
<div class="page_loader"></div>

<!-- Header Include -->
<div id="header-container"></div>

<script>
    // Load header.html content
    fetch('header.html')
        .then(response => response.text())
        .then(data => {
            document.getElementById('header-container').innerHTML = data;
        })
        .catch(error => {
            console.error('Error loading header:', error);
        });
</script>

<!-- Sub banner start -->
<div class="sub-banner">
    <div class="container">
        <div class="page-name">
            <h1>Change Password</h1>
            <ul>
                <li><a href="index.html">Index</a></li>
                <li><span>/</span>Change Password</li>
            </ul>
        </div>
    </div>
</div>

<div class="change-password content-area-7">
    <div class="container">
        <div class="row">
            <div class="col-lg-4 col-md-12">
                <!-- Avatar start -->
                <div class="edit-profile-photo">
                    <img id="profileAvatar" src="img/avatar/avatar-11.png" alt="profile-photo" class="img-fluid" onerror="this.src='img/avatar/avatar-11.png'">
                    <div class="change-photo-btn">
                        <div class="photoUpload">
                            <span><i class="fa fa-upload"></i> Upload Photo</span>
                            <input type="file" class="upload" onchange="updateAvatar(this)">
                        </div>
                    </div>
                </div>
                <!-- Avatar end -->
                <!-- My account box start -->
                <div class="my-account-box">
                    <ul>
                        <li>
                            <a href="my-profile.html">
                                <i class="flaticon-people"></i>My Profile
                            </a>
                        </li>
                        <li>
                            <a href="favorited-properties.html">
                                <i class="flaticon-favorite"></i>Favorited Properties
                            </a>
                        </li>
                        <li>
                            <a href="my-properties.html">
                                <i class="flaticon-internet"></i>My Properties
                            </a>
                        </li>
                        <li>
                            <a href="submit-property.html">
                                <i class="flaticon-cross"></i>Submit New Property
                            </a>
                        </li>
                        <li>
                            <a href="change-password.html" class="active">
                                <i class="flaticon-lock"></i>Change Password
                            </a>
                        </li>
                        <li>
                            <a href="index.html">
                                <i class="flaticon-exit"></i>Log Out
                            </a>
                        </li>
                    </ul>
                </div>
                <!-- My account box end -->
            </div>
            <div class="col-lg-8 col-md-12">
                <!-- My address start -->
                <div class="my-address">
                    <h3 class="heading-2">Change Password</h3>

                    <form id="changePasswordForm" action="#" method="POST">
                        <div class="form-group">
                            <label>Current Password</label>
                            <input type="password" class="input-text" name="currentPassword" placeholder="Current Password" minlength="6" required>
                        </div>
                        <div class="form-group">
                            <label>New Password</label>
                            <input type="password" class="input-text" name="newPassword" placeholder="New Password" minlength="6" required>
                        </div>
                        <div class="form-group">
                            <label>Confirm New Password</label>
                            <input type="password" class="input-text" name="confirmNewPassword" placeholder="Confirm New Password" minlength="6" required>
                        </div>
                        <button type="submit" class="btn btn-md button-theme">Save Changes</button>
                        <button type="button" id="logoutBtn" class="btn btn-md btn-secondary" style="margin-left:8px;">Log Out</button>
                    </form>
                </div>
                <!-- My address end -->
            </div>
        </div>
    </div>
</div>

<!-- Footer start -->
<div id="footer-container"></div>

<script>
    // Load footer.html content
    fetch('footer.html')
        .then(response => response.text())
        .then(data => {
            document.getElementById('footer-container').innerHTML = data;
        })
        .catch(error => {
            console.error('Error loading footer:', error);
        });
</script>

<script src="js/jquery-2.2.0.min.js"></script>
<script src="js/popper.min.js"></script>
<script src="js/bootstrap.min.js"></script>
<script src="js/bootstrap-submenu.js"></script>
<script src="js/rangeslider.js"></script>
<script src="js/jquery.mb.YTPlayer.js"></script>
<script src="js/wow.min.js"></script>
<script src="js/bootstrap-select.min.js"></script>
<script src="js/jquery.easing.1.3.js"></script>
<script src="js/jquery.scrollUp.js"></script>
<script src="js/jquery.mCustomScrollbar.concat.min.js"></script>
<script src="js/leaflet.js"></script>
<script src="js/leaflet-providers.js"></script>
<script src="js/leaflet.markercluster.js"></script>
<script src="js/dropzone.js"></script>
<script src="js/slick.min.js"></script>
<script src="js/jquery.filterizr.js"></script>
<script src="js/jquery.magnific-popup.min.js"></script>
<script src="js/jquery.countdown.js"></script>
<script src="js/maps.js"></script>
<script src="js/app.js"></script>

<script>
    (function(){
        var API_BASE_URL = 'http://localhost:5000';
        function getToken() { try { return localStorage.getItem('auth_token'); } catch(e){ return null; } }
        function clearAuth(){ try { localStorage.removeItem('auth_token'); localStorage.removeItem('current_user'); } catch(e){} }

        // Load user profile information
        function loadUserProfile() {
            try {
                const currentUser = JSON.parse(localStorage.getItem('current_user') || '{}');
                if (currentUser && currentUser.avatar) {
                    document.getElementById('profileAvatar').src = currentUser.avatar;
                }
            } catch (e) {
                console.warn('Failed to load user profile');
            }
        }

        // Update avatar when file is selected
        function updateAvatar(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                const formData = new FormData();
                formData.append('avatar', file);

                fetch(API_BASE_URL + '/api/users/avatar', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + token
                    },
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        document.getElementById('profileAvatar').src = data.data.avatar;
                        // Update localStorage
                        try {
                            const currentUser = JSON.parse(localStorage.getItem('current_user') || '{}');
                            currentUser.avatar = data.data.avatar;
                            localStorage.setItem('current_user', JSON.stringify(currentUser));
                        } catch (e) {
                            console.warn('Failed to update localStorage');
                        }
                        alert('Profile photo updated successfully!');
                    } else {
                        alert('Failed to update profile photo: ' + (data.message || 'Unknown error'));
                    }
                })
                .catch(error => {
                    console.error('Error updating avatar:', error);
                    alert('Error updating profile photo. Please try again.');
                });
            }
        }

        // Initialize page
        loadUserProfile();

        var form = document.getElementById('changePasswordForm');
        form.addEventListener('submit', function(e){
            e.preventDefault();
            var fd = new FormData(form);
            var currentPassword = (fd.get('currentPassword')||'').trim();
            var newPassword = (fd.get('newPassword')||'').trim();
            var confirmNewPassword = (fd.get('confirmNewPassword')||'').trim();
            if (!currentPassword || !newPassword || !confirmNewPassword) { alert('Please fill all fields.'); return; }
            if (newPassword !== confirmNewPassword) { alert('New passwords do not match.'); return; }

            fetch(API_BASE_URL + '/api/auth/password', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + token
                },
                body: JSON.stringify({ currentPassword: currentPassword, newPassword: newPassword })
            }).then(function(res){ return res.json().then(function(body){ return { status: res.status, body: body }; }); })
            .then(function(result){
                if (result.status === 200) {
                    alert('Password changed successfully. Please log in again.');
                    clearAuth();
                    window.location.href = 'login.html';
                } else {
                    var message = (result.body && (result.body.message || (result.body.errors && JSON.stringify(result.body.errors)))) || 'Failed to change password.';
                    alert(message);
                }
            }).catch(function(err){
                console.error('Change password failed:', err);
                alert('Unable to change password now.');
            });
        });

        document.getElementById('logoutBtn').addEventListener('click', function(){
            clearAuth();
            window.location.href = 'login.html';
        });
    })();
</script>

<!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
<script src="js/ie10-viewport-bug-workaround.js"></script>

</body>
</html>